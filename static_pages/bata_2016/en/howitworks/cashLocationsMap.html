<!DOCTYPE html>
<html>
  <head>
    <script src="../common/js/mqa.toolkit.js"></script>
	<script type='text/javascript' src='../common/jquery-1.9.1.min.js'></script>
	<script type='text/javascript' src='../common/js/main.js'></script>
	<link rel="stylesheet" href="../common/map.css"/>	
	<script type="text/javascript">
		// An example of using the MQA.EventUtil to hook into the window load event and execute the defined
		// function passed in as the last parameter. You could alternatively create a plain function here and
		// have it executed whenever you like (e.g. <body onload="yourfunction">).
		$(window).ready( function(){
			$('#map').css('width',$(window ).width()-15);
			$('#map').css('height',$(window ).height()-$('.container').height()-15);
		});

		$(window).on({
			orientationchange: function(e){
				document.location.reload();
			},
			resize:function(e){
				waitForFinalEvent("document.location.reload()", 200, "uniqueIdxxx");
			}
		});
		  
		var map;
		MQA.EventUtil.observe(window, 'load', function() {

			// create an object for options
			var options = {
				elt: document.getElementById('map'),           	// ID of map element on page
				zoom: 9,                                      	// initial zoom level of the map
				latLng: { lat: 37.77071473849608, lng: -122.0086669921875 },  	// center of map in latitude/longitude
				mtype: 'map',                                  	// map type (map, sat, hyb); defaults to map
				bestFitMargin: 0,                              	// margin offset from map viewport when applying a bestfit on shapes
				zoomOnDoubleClick: true,						// enable map to be zoomed in when double-clicking on map
				minimized: true                        
			};
			// construct an instance of MQA.TileMap with the options object
			window.map = new MQA.TileMap(options);
			
			// download the modules
			MQA.withModule('htmlpoi','new-route','largezoom', 'mousewheel','shapes', function() {	 
				// add the Large Zoom control
				map.addControl(
					new MQA.LargeZoom(),
					new MQA.MapCornerPlacement(MQA.MapCorner.TOP_LEFT, new MQA.Size(5,5))
				);
				// enable zooming with your mouse
				map.enableMouseWheelZoom();
				drawmarkers();
			});
			
		});

		function drawmarkers() {
			var id,name,street,city,state,zip,phone,notes,img,latval,lngval,html;
			
			jQuery.ajax({
				type: "GET",
				url: "../common/locations_cpn.xml",
				dataType: "xml",
				success: function(xml){
					var index=0;
					$(xml).find('location').each(function(){
						name = $(this).find('name').text();
						street = $(this).find('street').text();
						city = $(this).find('city').text();
						state = $(this).find('state').text();
						phone = $(this).find('phone').text();
						zip = $(this).find('zip').text();
						notes = $(this).find('notes').text();
						$.each(this.attributes, function(i, attrib){
							if(attrib.name=='id') id=attrib.value;
							if(attrib.name=='icon') img=attrib.value;
							if(attrib.name=='lat') latval=attrib.value;
							if(attrib.name=='long') lngval=attrib.value;
						});

						var poi = new MQA.Poi({ lat: latval, lng: lngval });
						
						if(img == 'Tnb Kiosk'){
							poi.setIcon(new MQA.Icon('../images/mm_20_red.png', 22, 32));
						}else if(img == 'SGS Location'){
							poi.setIcon(new MQA.Icon('../images/mm_20_green.png', 22, 32));
						}else {
							poi.setIcon(new MQA.Icon('../images/mm_20_yellow.png', 22, 32));
						}
						
						var address = street + ',<br>' + city + ', ' + state + ',' + zip;
						
						var toHere='<form id="to_'+id+'" style="display:none;" action="javascript:getDirections(\'to\',\''+id+'\');"><p class="small grey">End Address</p><input id="startAddr_to_'+id+'" class="address" type="text"><input value="Go" type="submit" ><p></p><input id="endAddr_to_'+id+'" value="'+address.replace('<br>',', ')+'@'+latval+','+lngval+'" type="hidden"></form>';
						
						var fromhere='<form id="from_'+id+'" style="display:none;" action="javascript:getDirections(\'from\',\''+id+'\');"><p class="small grey">Start Address</p><input id="endAddr_from_'+id+'" class="address" type="text"><input value="Go" type="submit" ><p></p><input id="startAddr_from_'+id+'" value="'+address.replace('<br>',', ')+'@'+latval+','+lngval+'" type="hidden"></form>';
						
						var html = '<B>'+name+'</B>'
										+'<br><span style="white-space: nowrap;">'+address+'<br>'+phone
										+'<br>'+'<b>Get Directions:</b>'
										+'<a href="javascript:void(0)" id="'+id+'" onclick="openDirpanel(this.id,true);">To Here</a>'
										+' - '
										+'<a href="javascript:void(0)" id="'+id+'" onclick="openDirpanel(this.id,false);">From Here</a></span>'+toHere+fromhere+'<span id="hidden_span_'+id+'" style="visibility:hidden"><br><br><br><br><br><br></span>';
						
										
						poi.setInfoContentHTML(html);
						poi.setShadowOffset({ x: 5, y: -25 });
						map.addShape(poi);

					});
				},
				error: function() {
					alert("An error occurred while loading MAP.");
				}					
			});				
		}	
		
		function openDirpanel(curId,toAddr){
			$('form').hide();
			if(true == toAddr){
				$('form[id=from_'+curId+']').show();
			}else{
				$('form[id=to_'+curId+']').show();
			}
			$('#hidden_span_'+curId).hide();
		}
		
		function getDirections( frmto,idval ) {
			var start = $('#startAddr_'+frmto+'_' + idval).val();
			var end = $('#endAddr_'+frmto+'_' + idval).val();
			
			map.addRoute({
			 request: {
			   locations: [start,end]
			 }
		   });
		}
		
		
	</script>
  </head>
  <body>
	<DIV id="MapOuter">
		<DIV id="map" ></DIV>
	</DIV>
	<div class="container">
	<b>LOCATION TYPE</b><br>
	<table>
		<tr>
			<td width="8%"><img src="../images/mm_20_green.png"></td>
			<td>PAYXCHANGE AUTHORIZED AGENT</td>
		</tr>
		<tr>
			<td width="8%"><img src="../images/mm_20_red.png"></td>
			<td>TOUCH-N-BUY SELF-SERVE KIOSK</td>
		</tr>
	</table>
	<br>
	Use cash at these locations to replenish a FasTrak or License Plate Account, make a One-Time Payment to cross the Golden Gate Bridge, pay a Golden Gate Bridge Toll Invoice, or pay a Violation Notice.
	</div>
  </body>
</html>